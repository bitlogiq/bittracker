name: iOS TestFlight

on:
  push:
    branches: [ main, master ]
    paths:
      - "ios/**"
      - "lib/**"
      - "pubspec.yaml"
      - ".github/workflows/ios-testflight.yml"
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.35.1"

      - name: Flutter packages
        run: flutter pub get

      # --- Decode and install signing assets ---
      - name: Decode signing assets
        run: |
          echo "${{ secrets.IOS_P12_B64 }}" | base64 --decode > dist.p12
          echo "${{ secrets.IOS_MOBILEPROVISION_B64 }}" | base64 --decode > BitTracker_AppStore.mobileprovision
          echo "${{ secrets.ASC_PRIVATE_KEY_B64 }}" | base64 --decode > AuthKey.p8

      - name: Install certificates
        run: |
          security create-keychain -p "" build.keychain
          security import dist.p12 -k ~/Library/Keychains/build.keychain -P "${{ secrets.IOS_P12_PASSWORD }}" -T /usr/bin/codesign
          security list-keychains -s ~/Library/Keychains/build.keychain
          security default-keychain -s ~/Library/Keychains/build.keychain
          security unlock-keychain -p "" ~/Library/Keychains/build.keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" ~/Library/Keychains/build.keychain

      - name: Install provisioning profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp BitTracker_AppStore.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Install Ruby and fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"

      - name: Install fastlane
        run: gem install fastlane -NV

      # --- Build IPA ---
      - name: Build IPA
        run: |
          bundle exec fastlane run build_app \
            workspace:"ios/Runner.xcworkspace" \
            scheme:"Runner" \
            export_method:"app-store" \
            output_directory:"build/ios" \
            output_name:"BitTracker.ipa" \
            xcargs:"DEVELOPMENT_TEAM=${{ secrets.APPLE_TEAM_ID }} PRODUCT_BUNDLE_IDENTIFIER=${{ secrets.IOS_BUNDLE_ID }}"

      # --- Upload to TestFlight ---
      - name: Upload to TestFlight
        run: |
          fastlane run upload_to_testflight \
            api_key_path:AuthKey.p8 \
            skip_waiting_for_build_processing:true \
            distribute_external:false

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: build/ios/*.ipa
