default_platform(:ios)

platform :ios do
  ###########################################################
  # App Store Connect API key (use env vars from GitHub Secrets)
  ###########################################################
  # Expected secrets:
  # ASC_KEY_ID, ASC_ISSUER_ID, ASC_PRIVATE_KEY (the PEM contents)
  def asc_api_key
    app_store_connect_api_key(
      key_id:        ENV['ASC_KEY_ID'],
      issuer_id:     ENV['ASC_ISSUER_ID'],
      key_content:   ENV['ASC_PRIVATE_KEY'],
      is_key_content_base64: false,
      in_house:      false
    )
  end

  ###########################################################
  # Run CocoaPods for Flutter iOS (creates Podfile.lock)
  ###########################################################
  before_all do
    Dir.chdir("ios") do
      sh("pod install")
    end
  end

  desc "CI lane to build and upload to TestFlight"
  lane :ci do
    # 1) Temp keychain (so match can import certs cleanly)
    create_keychain(
      name: "ci_tmp",
      default_keychain: true,
      timeout: 3600,
      unlock: true,
      add_to_keychain_search_list: true,
      password: "temp_password_123"
    )

    # 2) Use match for App Store signing assets
    #    - Keep this repo private
    #    - On CI prefer readonly: true (assets must already exist)
    match(
      type: "appstore",
      readonly: true,
      app_identifier: ENV['IOS_BUNDLE_ID'] || "za.co.bitlogiq.bittracker",
      git_url: ENV["MATCH_GIT_URL"],
      git_basic_authorization: ENV["MATCH_GIT_BASIC_AUTHORIZATION"],
      keychain_name: "ci_tmp",
      keychain_password: "temp_password_123"
    )

    # 3) Build (Flutter project workspace)
    #    - IMPORTANT: use the workspace under ios/
    #    - Avoid -allowProvisioningUpdates if you’re using match
    gym(
      workspace: "ios/Runner.xcworkspace",
      scheme: "Runner",
      configuration: "Release",
      clean: true,
      export_method: "app-store",
      output_directory: "ios/build",
      output_name: "BitTracker.ipa",
      # Team id from secrets, don’t over-specify codesign flags
      xcargs: "ONLY_ACTIVE_ARCH=NO DEVELOPMENT_TEAM=#{ENV['APPLE_TEAM_ID']}"
    )

    # 4) Upload to TestFlight via API key (no 2FA headaches)
    asc_api_key
    upload_to_testflight(
      skip_submission: true,
      skip_waiting_for_build_processing: true
    )
  end
end
