    steps:
      - name: Checkout app
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install fastlane (and optionally Cocoapods)
        shell: bash
        run: |
          gem install fastlane
          brew install cocoapods || true

      - name: Write ASC API key JSON
        shell: bash
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
        run: |
          ruby -e 'require "json";
                   data = {
                     "key_id"    => ENV["ASC_KEY_ID"],
                     "issuer_id" => ENV["ASC_ISSUER_ID"],
                     "key"       => ENV["ASC_PRIVATE_KEY"],
                     "duration"  => 1200,
                     "in_house"  => false
                   };
                   File.write("AuthKey.json", JSON.generate(data))'

      - name: Pull certs/profiles (readonly)
        shell: bash
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        run: |
          fastlane match appstore \
            --readonly true \
            --git_url "$MATCH_GIT_URL" \
            --git_branch "$MATCH_GIT_BRANCH" \
            --git_basic_authorization "${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}" \
            --app_identifier "$APP_IDENTIFIER" \
            --team_id "$TEAM_ID" \
            --username "$APPLE_ID" \
            --api_key_path ./AuthKey.json

      # ---------- Flutter build ----------
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          # flutter-version: "3.35.1"

      - name: Flutter pub get
        run: flutter pub get

      - name: Precache iOS artifacts
        run: flutter precache --ios

      - name: Build IPA (App Store)
        env:
          CI: "true"
        shell: bash
        run: |
          /usr/libexec/PlistBuddy -c "Set :DEVELOPMENT_TEAM $TEAM_ID" ios/Runner.xcodeproj/project.pbxproj || true
          flutter build ipa --release --export-method app-store

      # ---------- Upload to TestFlight ----------
      - name: Upload to TestFlight
        shell: bash
        run: |
          fastlane pilot upload \
            --api_key_path ./AuthKey.json \
            --ipa "build/ios/ipa/Runner.ipa" \
            --skip_waiting_for_build_processing true
