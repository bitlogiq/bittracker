name: iOS Build & TestFlight

on:
  workflow_dispatch:
  push:
    tags:
      - 'ios-v*'     # e.g. ios-v1.2.3 â€” push a tag to trigger

jobs:
  build:
    runs-on: macos-14  # Xcode 15.4 on Apple Silicon

    env:
      # Fastlane/Match inputs (add these as GitHub Secrets)
      MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}               # e.g. https://<token>@github.com/you/certs.git
      MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}             # the match encryption password

      # App Store Connect API key (recommended for TestFlight upload)
      ASC_KEY_ID:        ${{ secrets.ASC_KEY_ID }}
      ASC_ISSUER_ID:     ${{ secrets.ASC_ISSUER_ID }}
      ASC_KEY_P8:        ${{ secrets.ASC_KEY_P8 }}              # entire contents of the .p8 file

      # (Optional) if your Fastfile reads these:
      APP_IDENTIFIER: za.co.bitlogiq.bittracker
      TEAM_ID: R4R4AW7JUQ

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 15.4
        run: sudo xcode-select -s /Applications/Xcode_15.4.app

      - name: Set up Ruby (uses your Gemfile)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.2
          bundler-cache: true

      - name: Create App Store Connect API key file
        run: |
          cat > appstore_connect_api_key.json <<'JSON'
          {
            "key_id": "${ASC_KEY_ID}",
            "issuer_id": "${ASC_ISSUER_ID}",
            "key": "${ASC_KEY_P8}"
          }
          JSON
          echo "APP_STORE_CONNECT_API_KEY_PATH=$PWD/appstore_connect_api_key.json" >> $GITHUB_ENV

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
            ~/.cocoapods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install CocoaPods (from Gemfile if present)
        working-directory: ios
        run: |
          bundle exec pod install --verbose

      - name: Build & Upload via Fastlane
        run: |
          bundle exec fastlane ios ci
