name: iOS TestFlight

on:
  push:
    branches: [ main, master ]
    paths:
      - "ios/**"
      - "lib/**"
      - "pubspec.yaml"
      - ".github/workflows/ios-testflight.yml"
  workflow_dispatch: {}

jobs:
  ios:
    runs-on: macos-14

    env:
      FLUTTER_VERSION: '3.35.1'
      IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      APPLE_ID_EMAIL: ${{ secrets.APPLE_ID_EMAIL }}
      ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
      ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      ASC_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
      MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
      MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
      MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug â€¢ Repo state
        run: |
          echo "PWD=$(pwd)"
          ls -la
          test -f pubspec.yaml || (echo "pubspec.yaml missing" && exit 1)

      # ---- Flutter toolchain first (so FLUTTER_ROOT exists) ----
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Debug â€¢ Flutter
        run: |
          flutter --version
          which flutter

      - name: Precache iOS & fetch packages
        run: |
          set -e
          flutter precache --ios
          flutter pub get

      # Ensure FLUTTER_ROOT is exported (helps Podfile fallback logic)
      - name: Export FLUTTER_ROOT
        shell: bash
        run: |
          set -e
          FLUTTER_BIN="$(which flutter)"
          FLUTTER_ROOT="$(cd "$(dirname "$FLUTTER_BIN")/.." && pwd)"
          echo "FLUTTER_ROOT=$FLUTTER_ROOT" >> "$GITHUB_ENV"
          echo "âœ… FLUTTER_ROOT=$FLUTTER_ROOT"

      # If Generated.xcconfig was committed from Windows, regenerate it for macOS
      - name: Normalize Generated.xcconfig (Windows path guard)
        run: |
          set -e
          if [ -f ios/Flutter/Generated.xcconfig ] && grep -qi '^FLUTTER_ROOT=c:' ios/Flutter/Generated.xcconfig; then
            echo "Windows path detected in Generated.xcconfig; regenerating..."
            rm -f ios/Flutter/Generated.xcconfig
            flutter pub get
          fi
          test -f ios/Flutter/Generated.xcconfig || (echo "Generated.xcconfig missing after regen" && exit 1)
          echo "âœ… ios/Flutter/Generated.xcconfig OK"

      # (Optional) Cache Pods by lockfile hash
      - name: Cache Pods
        uses: actions/cache@v4
        with:
          path: ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      # ---- Ruby / fastlane / cocoapods ----
      - name: Install Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: false

      - name: Install gems (cocoapods + fastlane)
        run: |
          set -e
          gem install --no-document cocoapods -v "~> 1.15"
          gem install --no-document fastlane   -v ">= 2.222"
          pod --version
          fastlane --version

      # ---- Clean & install Pods in correct order ----
      - name: Reset Pods
        run: rm -rf ios/Pods ios/Podfile.lock

      - name: Pod repo update & install
        working-directory: ios
        run: |
          set -e
          pod repo update
          pod install
          echo "âœ… pod install complete"

      # ---- Early sanity build (no signing) to catch Pod/Swift issues ----
      - name: Build iOS (no codesign)
        run: |
          set -e
          flutter build ios --release --no-codesign

      # ---- App Store Connect API key for fastlane ----
      - name: Create App Store Connect API key file
        shell: bash
        run: |
          set -e
          cat > AuthKey.json <<'JSON'
          {
            "key_id": "${ASC_KEY_ID}",
            "issuer_id": "${ASC_ISSUER_ID}",
            "key": "${ASC_PRIVATE_KEY}",
            "duration": 1200,
            "in_house": false
          }
          JSON
          echo "âœ… AuthKey.json created"

      # ---- Keychain + match (FIRST RUN: readonly:false to create certs/profiles) ----
      - name: Set up keychain & fetch signing with match
        env:
          MATCH_KEYCHAIN_NAME: build.keychain
          MATCH_KEYCHAIN_PASSWORD: temp_password_123
        run: |
          set -e
          fastlane run create_keychain \
            name:"$MATCH_KEYCHAIN_NAME" \
            password:"$MATCH_KEYCHAIN_PASSWORD" \
            default_keychain:true \
            unlock:true \
            timeout:3600

          # If your match repo requires Basic Auth, env is already set
          if [ -n "${MATCH_GIT_BASIC_AUTHORIZATION}" ]; then
            export MATCH_GIT_BASIC_AUTHORIZATION="${MATCH_GIT_BASIC_AUTHORIZATION}"
          fi

          # FIRST SUCCESSFUL RUN ONLY: allow creation (readonly:false)
          fastlane run match \
            type:"appstore" \
            app_identifier:"${IOS_BUNDLE_ID}" \
            git_url:"${MATCH_GIT_URL}" \
            readonly:false \
            api_key_path:"AuthKey.json" \
            keychain_name:"$MATCH_KEYCHAIN_NAME" \
            keychain_password:"$MATCH_KEYCHAIN_PASSWORD"

      # ---- Build IPA with fastlane (gym) ----
      - name: Build IPA
        run: |
          set -e
          fastlane run build_app \
            scheme:"Runner" \
            workspace:"ios/Runner.xcworkspace" \
            export_method:"app-store" \
            clean:true \
            include_bitcode:false \
            output_directory:"ios/build" \
            output_name:"BitTracker.ipa" \
            xcargs:"DEVELOPMENT_TEAM=${APPLE_TEAM_ID} PRODUCT_BUNDLE_IDENTIFIER=${IOS_BUNDLE_ID}"
          ls -lah ios/build

      # ---- Upload to TestFlight ----
      - name: Upload to TestFlight
        run: |
          set -e
          fastlane run upload_to_testflight \
            api_key_path:"AuthKey.json" \
            skip_waiting_for_build_processing:true \
            distribute_external:false
          echo "âœ… Upload to TestFlight initiated"

      # ---- Keep artifacts (IPA) ----
      - name: Keep artifacts (IPA)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ios/build/*.ipa
          if-no-files-found: warn

      - name: Done
        if: always()
        run: echo "ðŸ Workflow finished."
