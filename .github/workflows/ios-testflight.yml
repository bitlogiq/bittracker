name: iOS TestFlight

on:
  push:
    branches: [ main, master ]
    paths:
      - "ios/**"
      - "lib/**"
      - "pubspec.yaml"
      - ".github/workflows/ios-testflight.yml"
  workflow_dispatch: {}

jobs:
  ios:
    runs-on: macos-14

    env:
      # Keep in sync with your local Flutter
      FLUTTER_VERSION: '3.35.1'

      # App identifiers / Apple details (set as GitHub Action Secrets)
      IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}          # e.g. com.bitlogiq.bittracker
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}          # e.g. 1A2BC3D4EF
      APPLE_ID_EMAIL: ${{ secrets.APPLE_ID_EMAIL }}        # Apple ID linked to App Store Connect

      # App Store Connect API key (Secrets)
      ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
      ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      ASC_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      # --- Prepare Flutter for iOS ---
      - name: Precache iOS and fetch packages
        run: |
          flutter --version
          flutter precache --ios
          flutter pub get

      # --- Safety net: ensure ios/Flutter/podhelper.rb exists ---
      - name: Ensure podhelper.rb exists (fallback)
        shell: bash
        run: |
          set -e
          mkdir -p ios/Flutter
          FLUTTER_BIN="$(which flutter)"
          FLUTTER_ROOT="$(cd "$(dirname "$FLUTTER_BIN")/.." && pwd)"
          if [ ! -f ios/Flutter/podhelper.rb ]; then
            cp "$FLUTTER_ROOT/packages/flutter_tools/bin/podhelper.rb" ios/Flutter/podhelper.rb
          fi
          ls -lah ios/Flutter

      # --- Export FLUTTER_ROOT for CocoaPods ---
      - name: Export FLUTTER_ROOT for CocoaPods
        shell: bash
        run: |
          FLUTTER_BIN="$(which flutter)"
          FLUTTER_ROOT="$(cd "$(dirname "$FLUTTER_BIN")/.." && pwd)"
          echo "FLUTTER_ROOT=$FLUTTER_ROOT" >> "$GITHUB_ENV"
          echo "FLUTTER_ROOT resolved to: $FLUTTER_ROOT"

      # --- Ruby / Fastlane / CocoaPods ---
      - name: Install Ruby + fastlane + cocoapods
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: false
      - run: |
          gem install --no-document cocoapods -v "~> 1.15"
          gem install --no-document fastlane   -v ">= 2.222"

      - name: CocoaPods install
        run: |
          cd ios
          pod repo update
          pod install

      # --- App Store Connect API key file ---
      - name: Create App Store Connect API key file
        shell: bash
        run: |
          cat > AuthKey.json <<'JSON'
          {
            "key_id": "${ASC_KEY_ID}",
            "issuer_id": "${ASC_ISSUER_ID}",
            "key": "${ASC_PRIVATE_KEY}",
            "duration": 1200,
            "in_house": false
          }
          JSON
          ls -lah AuthKey.json

      # --- Build IPA ---
      - name: Build IPA
        run: |
          fastlane run build_app \
            scheme:"Runner" \
            workspace:"ios/Runner.xcworkspace" \
            export_method:"app-store" \
            clean:true \
            include_bitcode:false \
            output_directory:"ios/build" \
            output_name:"BitTracker.ipa" \
            xcargs:"DEVELOPMENT_TEAM=${APPLE_TEAM_ID} PRODUCT_BUNDLE_IDENTIFIER=${IOS_BUNDLE_ID}"

      # --- Upload to TestFlight ---
      - name: Upload to TestFlight
        run: |
          fastlane run upload_to_testflight \
            api_key_path:"AuthKey.json" \
            skip_waiting_for_build_processing:true \
            distribute_external:false

      # --- Keep artifacts (IPA) ---
      - name: Keep artifacts (IPA)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ios/build/*.ipa
          if-no-files-found: warn
