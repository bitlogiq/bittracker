    steps:
      - name: Checkout app
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install fastlane
        run: gem install fastlane

      - name: Write ASC API key JSON
        shell: bash
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
        run: |
          ruby -e 'require "json";
                   data = {
                     "key_id"    => ENV["ASC_KEY_ID"],
                     "issuer_id" => ENV["ASC_ISSUER_ID"],
                     "key"       => ENV["ASC_PRIVATE_KEY"],
                     "duration"  => 1200,
                     "in_house"  => false
                   };
                   File.write("AuthKey.json", JSON.generate(data))'

      # -------- Warm Flutter iOS build to generate Pods (NO direct `pod install`) --------
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          # flutter-version: "3.35.1"   # optional pin

      - name: Flutter pub get
        run: flutter pub get

      - name: Precache iOS artifacts
        run: flutter precache --ios

      - name: Ensure iOS folder exists
        shell: bash
        run: |
          if [ ! -d ios ]; then
            flutter create . --platforms ios
          fi

      - name: Warm iOS build (generates Pods)
        env:
          CI: "true"
        run: flutter build ios --profile --no-codesign

      # -------- Pull certs/profiles (readonly) --------
      - name: Pull certs/profiles (readonly)
        shell: bash
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        run: |
          fastlane match appstore \
            --readonly true \
            --git_url "https://github.com/bitlogiq/ios-cert-store.git" \
            --git_branch "main" \
            --git_basic_authorization "${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}" \
            --app_identifier "${{ secrets.APP_IDENTIFIER }}" \
            --team_id "${{ secrets.TEAM_ID }}" \
            --username "${{ secrets.APPLE_ID }}" \
            --api_key_path ./AuthKey.json

      # -------- Final IPA build & upload --------
      - name: Build IPA (App Store)
        env:
          CI: "true"
        shell: bash
        run: |
          /usr/libexec/PlistBuddy -c "Set :DEVELOPMENT_TEAM $TEAM_ID" ios/Runner.xcodeproj/project.pbxproj || true
          flutter build ipa --release --export-method app-store

      - name: Upload to TestFlight
        shell: bash
        run: |
          fastlane pilot upload \
            --api_key_path ./AuthKey.json \
            --ipa "build/ios/ipa/Runner.ipa" \
            --skip_waiting_for_build_processing true
