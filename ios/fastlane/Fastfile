default_platform(:ios)

platform :ios do
  desc "CI lane to build and upload to TestFlight"
  lane :ci do
    # --- Temporary CI keychain ---
    create_keychain(
      name: "ci_tmp",
      default_keychain: true,
      timeout: 3600,
      unlock: true,
      add_to_keychain_search_list: true,
      password: "temp_password_123"
    )

    # --- App Store Connect API key (from GitHub Secrets) ---
    app_store_connect_api_key(
      key_id:          ENV["ASC_KEY_ID"],
      issuer_id:       ENV["ASC_ISSUER_ID"],
      key_content:     ENV["ASC_PRIVATE_KEY"], # PEM content, not base64
      is_key_content_base64: false,
      in_house:        false
    )

    # --- Sync signing with match ---
    match(
      type: "appstore",
      readonly: false, # allow CI to create/update on first run
      app_identifier: "za.co.bitlogiq.bittracker",
      git_url: ENV["MATCH_GIT_URL"],
      git_basic_authorization: ENV["MATCH_GIT_BASIC_AUTHORIZATION"],
      keychain_name: "ci_tmp",
      keychain_password: "temp_password_123"
    )

    # --- Build (gym) ---
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      configuration: "Release",
      export_method: "app-store",
      clean: true,
      output_directory: "build",
      output_name: "BitTracker",
      include_bitcode: false,
      # Allow Xcode to pick the matched provisioning profiles
      # Ensure your Apple Team ID is correct here:
      xcargs: "DEVELOPMENT_TEAM=R4R4AW7JUQ -allowProvisioningUpdates"
    )

    # --- Upload to TestFlight ---
    upload_to_testflight(
      skip_submission: true,
      skip_waiting_for_build_processing: true
    )
  ensure
    # Always try to remove the temporary keychain
    begin
      delete_keychain(name: "ci_tmp")
    rescue => e
      UI.message("Keychain cleanup skipped: #{e}")
    end
  end
end
